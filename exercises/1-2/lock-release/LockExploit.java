public class LockExploit {
    public static void main(String[] args) throws InterruptedException {
        VulnerableLockHandler handler = new VulnerableLockHandler();

        System.out.println("--- Starting Lock Leak Exploit ---");

        // Thread 1: Will acquire the lock and fail, leaking it.
        Thread leakingThread = new Thread(() -> {
            try {
                handler.performAction(true);
            } catch (Exception e) {
                System.err.println("Thread 1 caught exception: " + e.getMessage());
            }
        }, "LeakingThread");

        // Thread 2: Will try to acquire the lock but will hang indefinitely.
        Thread hangingThread = new Thread(() -> {
            System.out.println("Thread 2 attempting to acquire lock...");
            handler.performAction(false);
            System.out.println("Thread 2 successfully finished (SHOULD NOT HAPPEN if leaked).");
        }, "HangingThread");

        leakingThread.start();
        leakingThread.join(); // Wait for it to fail and leak the lock

        System.out.println("\nThread 1 has finished (and leaked the lock).");
        System.out.println("Starting Thread 2. It will likely hang forever...");

        hangingThread.start();

        // Monitor Thread 2
        Thread.sleep(3000);
        if (hangingThread.isAlive()) {
            System.err.println("\n[SUCCESS] Exploit confirmed: Thread 2 is still hanging after 3 seconds.");
            System.err
                    .println("The application is effectively Deadlocked/Hanging because the lock was never released.");
            System.exit(1); // Force exit since hangingThread won't stop
        } else {
            System.out.println("\n[FAILURE] Exploit failed: Thread 2 finished. The lock was released.");
        }
    }
}
