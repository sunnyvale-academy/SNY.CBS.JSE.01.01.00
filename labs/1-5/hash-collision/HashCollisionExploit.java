import java.util.ArrayList;
import java.util.List;

/**
 * HashCollisionExploit.java
 * 
 * Demonstrates how to generate strings that produce hash collisions in Java.
 * It measures the performance impact of these collisions on a HashMap.
 */
public class HashCollisionExploit {

    public static void main(String[] args) {
        int count = 10000;
        VulnerableSessionManager manager = new VulnerableSessionManager();

        System.out.println("--- Hash Collision Performance Lab ---");
        System.out.println("Number of entries to process: " + count + "\n");

        // Test 1: Random Keys (Normal Case)
        System.out.println("1. Processing Normal Keys...");
        long startTime = System.currentTimeMillis();
        for (int i = 0; i < count; i++) {
            manager.createSession("Session_" + i, "User_" + i);
        }
        long normalTime = System.currentTimeMillis() - startTime;
        System.out.println("Time taken with Normal Keys: " + normalTime + " ms");

        // Reset Manager
        manager = new VulnerableSessionManager();

        // Test 2: Colliding Keys (Attack Case)
        // Strings "Aa" and "BB" have the same hashCode in Java: 2112
        // We can generate 2^n strings with same hashCode by combining these pairs.
        System.out.println("\n2. Generating Colliding Keys...");
        List<String> collidingKeys = generateCollisions(count);

        System.out.println("Processing Colliding Keys...");
        startTime = System.currentTimeMillis();
        for (String key : collidingKeys) {
            manager.createSession(key, "Attacker_Data");
        }
        long collisionTime = System.currentTimeMillis() - startTime;
        System.out.println("Time taken with Colliding Keys: " + collisionTime + " ms");

        System.out.println("\n--- Summary ---");
        System.out.println("Slowdown Factor: " + (double) collisionTime / normalTime + "x");

        if (collisionTime > normalTime * 2) {
            System.out.println("WARNING: Significant performance degradation detected due to hash collisions!");
        }
    }

    /**
     * Generates a list of strings that all have the same hashCode.
     * Based on the fact that "Aa".hashCode() == "BB".hashCode().
     */
    private static List<String> generateCollisions(int targetCount) {
        List<String> list = new ArrayList<>();
        list.add("");

        while (list.size() < targetCount) {
            List<String> nextLevel = new ArrayList<>();
            for (String s : list) {
                nextLevel.add(s + "Aa");
                nextLevel.add(s + "BB");
            }
            list = nextLevel;
        }

        return list.subList(0, targetCount);
    }
}
