/**
 * ExceptionLeakExploit.java
 * 
 * This class demonstrates how an attacker (or simply an unauthorized observer)
 * can gain sensitive information by catching an exception that leaks internal
 * secrets.
 */
public class ExceptionLeakExploit {
    public static void main(String[] args) {
        System.out.println("=== Lab 2-1: Purge Sensitive Information from Exceptions ===\n");

        VulnerableDatabaseService vulnerableService = new VulnerableDatabaseService();
        SecureDatabaseService secureService = new SecureDatabaseService();

        String url = "jdbc:postgresql://prod-db.example.com:5432/finance";
        String user = "finance_admin";
        String secret = "SuperSecretP@ssword123!";

        // 1. Trigger the vulnerability
        System.out.println("[Step 1] Attempting connection via Vulnerable Service...");
        try {
            vulnerableService.connect(url, user, secret);
        } catch (Exception e) {
            System.err.println("CAUGHT EXCEPTION: " + e.getMessage());

            if (e.getMessage().contains(secret)) {
                System.out.println("\n[!] EXPLOIT SUCCESS: The password was leaked in the exception message!");
            }
        }

        System.out.println("\n--------------------------------------------------\n");

        // 2. Attempt the same via the Secure Service
        System.out.println("[Step 2] Attempting connection via Secure Service...");
        try {
            secureService.connect(url, user, secret);
        } catch (Exception e) {
            System.err.println("CAUGHT EXCEPTION: " + e.getMessage());

            if (!e.getMessage().contains(secret)) {
                System.out.println("\n[+] SUCCESS: The Secure Service did not leak the password.");
            } else {
                System.out.println("\n[-] FAILURE: The Secure Service still leaks sensitive info.");
            }
        }
    }
}
